<launch>
  <set_env name="RCUTILS_LOGGING_BUFFERED_STREAM" value="1"/>

  <!-- 공통 인자 (이름/값은 기존과 최대한 동일) -->
  <arg name="namespace" default=""/>
  <arg name="use_sim_time" default="False"/>
  <arg name="params_file" default="$(find-pkg-share pinky_navigation)/params/nav2_params.yaml"/>
  <arg name="autostart" default="True"/>
  <arg name="container_name" default="nav2_container"/>
  <arg name="use_composition" default="True"/>
  <arg name="use_respawn" default="False"/>
  <arg name="log_level" default="info"/>
  <arg name="lifecycle_nodes_nav" default="['controller_server', 'smoother_server', 'planner_server', 'behavior_server', 'bt_navigator', 'waypoint_follower', 'velocity_smoother']"/>

  <!-- Cartographer 설정 -->
  <arg name="cartographer_prefix" default="$(find-pkg-share pinky_cartographer)"/>
  <arg name="cartographer_config_dir" default="$(var cartographer_prefix)/params"/>
  <arg name="configuration_basename" default="nav2_cartographer_params.lua"/>
  <arg name="lidar_topic" default="/scan"/>
  <arg name="occ_res" default="0.05"/>
  <arg name="occ_period" default="1.0"/>

  <group>
    <push-ros-namespace namespace="$(var namespace)"/>

    <!-- (옵션) 컴포저블 컨테이너 -->
    <node
      pkg="rclcpp_components"
      exec="component_container_isolated"
      name="$(var container_name)"
      output="screen"
      args="--ros-args --log-level $(var log_level)"
      if="$(var use_composition)"
    >
      <param from="$(var params_file)"/>
      <param name="autostart" value="$(var autostart)"/>
      <param name="use_sim_time" value="$(var use_sim_time)"/>
      <remap from="/tf" to="tf"/>
      <remap from="/tf_static" to="tf_static"/>
    </node>

    <!-- ===== SLAM: Cartographer (include 대신 노드 직접 기동; remap은 node 안에서만!) ===== -->
    <node
      pkg="cartographer_ros"
      exec="cartographer_node"
      name="cartographer_node"
      output="screen"
      args="-configuration_directory $(var cartographer_config_dir) -configuration_basename $(var configuration_basename)"
    >
      <param name="use_sim_time" value="$(var use_sim_time)"/>
      <remap from="/scan" to="$(var lidar_topic)"/>
    </node>

    <!-- /map 퍼블리시 -->
    <node
      pkg="cartographer_ros"
      exec="cartographer_occupancy_grid_node"
      name="cartographer_occupancy_grid_node"
      output="screen"
      args="-resolution $(var occ_res) -publish_period_sec $(var occ_period)"
    >
      <param name="use_sim_time" value="$(var use_sim_time)"/>
    </node>

    <!-- ===== Nav2(웨이포인트 포함) 기존 navigation_launch.xml 그대로 사용 ===== -->
    <include file="$(find-pkg-share pinky_navigation)/launch/navigation_launch.xml">
      <arg name="params_file" value="$(var params_file)"/>
      <arg name="use_sim_time" value="$(var use_sim_time)"/>
      <arg name="autostart" value="$(var autostart)"/>
      <arg name="use_composition" value="$(var use_composition)"/>
      <arg name="use_respawn" value="$(var use_respawn)"/>
      <arg name="container_name" value="$(var container_name)"/>
      <arg name="lifecycle_nodes" value="$(var lifecycle_nodes_nav)"/>
    </include>

    <!-- ※ 정적맵/AMCL은 SLAM 모드에서 제외 -->
    <!-- (기존) localization_launch.xml include는 제거 -->
  </group>
</launch>